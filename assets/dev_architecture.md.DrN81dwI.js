import{_ as u,C as r,o as l,c as b,j as a,a as n,b as o,w as s,E as t,a4 as p,a3 as d}from"./chunks/framework.CqFBhNnV.js";const _=JSON.parse('{"title":"项目架构","description":"","frontmatter":{"title":"项目架构","order":2},"headers":[],"relativePath":"dev/architecture.md","filePath":"dev/architecture.md","lastUpdated":1772007002000}'),A={name:"dev/architecture.md"},m={tabindex:"0"};function h(g,e,E,T,v,B){const i=r("Mermaid"),c=r("Badge");return l(),b("div",null,[e[7]||(e[7]=a("h1",{id:"项目架构",tabindex:"-1"},[n("项目架构 "),a("a",{class:"header-anchor",href:"#项目架构","aria-label":'Permalink to "项目架构"'},"​")],-1)),e[8]||(e[8]=a("h2",{id:"整体架构",tabindex:"-1"},[n("整体架构 "),a("a",{class:"header-anchor",href:"#整体架构","aria-label":'Permalink to "整体架构"'},"​")],-1)),e[9]||(e[9]=a("p",null,[n("Fredica 采用"),a("strong",null,"本地服务 + 内嵌 WebView"),n("的架构，将 Kotlin 后端服务与 React 前端结合在一个桌面应用中。")],-1)),(l(),o(p,null,{default:s(()=>[t(i,{id:"mermaid-9",class:"mermaid",graph:"graph%20TB%0A%20%20%20%20subgraph%20Desktop%5B%22%E6%A1%8C%E9%9D%A2%E5%BA%94%E7%94%A8%EF%BC%88composeApp%EF%BC%89%22%5D%0A%20%20%20%20%20%20%20%20CUI%5BCompose%20UI%20%E7%AA%97%E5%8F%A3%5D%0A%20%20%20%20%20%20%20%20WV%5BAppWebView%20%E5%86%85%E5%B5%8C%E6%B5%8F%E8%A7%88%E5%99%A8%5D%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20WebUI%5B%22%E5%89%8D%E7%AB%AF%EF%BC%88fredica-webui%EF%BC%89%22%5D%0A%20%20%20%20%20%20%20%20React%5BReact%20%2B%20React%20Router%5D%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20Backend%5B%22%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%EF%BC%88shared%2FjvmMain%EF%BC%89%22%5D%0A%20%20%20%20%20%20%20%20Ktor%5BKtor%20Server%20%3A7631%5D%0A%20%20%20%20%20%20%20%20DB%5B(SQLite%20.data%2Fdb%2F)%5D%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20AI%5B%22AI%20%E5%A4%84%E7%90%86%E6%9C%8D%E5%8A%A1%EF%BC%88Python%EF%BC%89%22%5D%0A%20%20%20%20%20%20%20%20Py%5BPython%20%E6%A8%A1%E5%9E%8B%E6%9C%8D%E5%8A%A1%20%3A7632%5D%0A%20%20%20%20end%0A%0A%20%20%20%20CUI%20--%3E%20WV%0A%20%20%20%20WV%20%3C--%3E%20React%0A%20%20%20%20React%20%3C--%3E%7CHTTP%20API%7C%20Ktor%0A%20%20%20%20Ktor%20%3C--%3E%20DB%0A%20%20%20%20Ktor%20%3C--%3E%7C%E5%86%85%E9%83%A8%20HTTP%7C%20Py%0A"})]),fallback:s(()=>[...e[0]||(e[0]=[n(" Loading... ",-1)])]),_:1})),e[10]||(e[10]=d(`<h2 id="模块划分" tabindex="-1">模块划分 <a class="header-anchor" href="#模块划分" aria-label="Permalink to &quot;模块划分&quot;">​</a></h2><h3 id="composeapp-—-桌面宿主" tabindex="-1"><code>composeApp</code> — 桌面宿主 <a class="header-anchor" href="#composeapp-—-桌面宿主" aria-label="Permalink to &quot;\`composeApp\` — 桌面宿主&quot;">​</a></h3><ul><li><strong>技术</strong>：Kotlin Compose Multiplatform</li><li><strong>职责</strong>： <ul><li>创建桌面窗口，托管 <code>AppWebView</code></li><li>通过 JS Bridge 向 WebView 注入应用配置（端口、Token 等）</li><li>响应 WebView 发出的 Native 消息（如打开系统浏览器、保存配置）</li><li>启动内嵌的 Ktor API 服务器</li></ul></li><li><strong>支持平台</strong>：JVM Desktop（Windows / macOS / Linux）、Android</li></ul><p><strong>JS Bridge 消息类型：</strong></p><table tabindex="0"><thead><tr><th>消息 Handler</th><th>方向</th><th>说明</th></tr></thead><tbody><tr><td><code>GetAppConfig</code></td><td>Native → Web</td><td>Web 启动时获取服务器配置</td></tr><tr><td><code>SaveAppConfig</code></td><td>Web → Native</td><td>用户在设置页修改配置后保存</td></tr><tr><td><code>OpenBrowser</code></td><td>Web → Native</td><td>在系统默认浏览器中打开 URL</td></tr></tbody></table><h3 id="shared-—-跨平台核心" tabindex="-1"><code>shared</code> — 跨平台核心 <a class="header-anchor" href="#shared-—-跨平台核心" aria-label="Permalink to &quot;\`shared\` — 跨平台核心&quot;">​</a></h3><ul><li><strong>技术</strong>：Kotlin Multiplatform（commonMain + jvmMain + androidMain）</li><li><strong>职责</strong>： <ul><li>定义所有 API 路由的请求/响应数据模型（<code>commonMain</code>）</li><li>JVM 端实现 Ktor 服务器初始化与路由注册（<code>jvmMain</code>）</li><li>数据库表结构与 Ktorm ORM 实体定义</li><li>跨平台工具函数</li></ul></li></ul><p><strong>目录结构：</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>shared/src/</span></span>
<span class="line"><span>├── commonMain/kotlin/</span></span>
<span class="line"><span>│   ├── api/</span></span>
<span class="line"><span>│   │   ├── FredicaApi.kt          # API 入口与路由注册</span></span>
<span class="line"><span>│   │   └── routes/                # 各业务路由实现</span></span>
<span class="line"><span>│   ├── db/                        # 数据库表定义（Ktorm）</span></span>
<span class="line"><span>│   └── apputil/                   # 工具函数</span></span>
<span class="line"><span>└── jvmMain/kotlin/</span></span>
<span class="line"><span>    └── api/</span></span>
<span class="line"><span>        └── FredicaApi.jvm.kt      # Ktor 服务器启动、认证、DB 初始化</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="fredica-webui-—-react-前端" tabindex="-1"><code>fredica-webui</code> — React 前端 <a class="header-anchor" href="#fredica-webui-—-react-前端" aria-label="Permalink to &quot;\`fredica-webui\` — React 前端&quot;">​</a></h3><ul><li><strong>技术</strong>：React 19 + React Router 7（文件系统路由）+ Tailwind CSS 4</li><li><strong>构建工具</strong>：Vite</li><li><strong>职责</strong>：所有用户交互界面</li></ul><p><strong>路由结构（文件系统路由）：</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>app/routes/</span></span>
<span class="line"><span>├── _index.tsx                          # 服务器连接配置页</span></span>
<span class="line"><span>├── library._index.tsx                  # 素材库主页</span></span>
<span class="line"><span>├── add-resource._index.tsx             # 添加资源入口</span></span>
<span class="line"><span>├── add-resource.bilibili.tsx           # B 站导入导航</span></span>
<span class="line"><span>├── add-resource.bilibili.favorite.tsx  # 收藏夹 ID 输入</span></span>
<span class="line"><span>├── add-resource.bilibili.favorite.fid.$fid.tsx  # 收藏夹视频列表</span></span>
<span class="line"><span>├── add-resource.bilibili.collection.tsx  # 合集（UI 框架）</span></span>
<span class="line"><span>├── add-resource.bilibili.multi-part.tsx  # 多 P 视频（UI 框架）</span></span>
<span class="line"><span>├── add-resource.bilibili.uploader.tsx   # UP 主（UI 框架）</span></span>
<span class="line"><span>├── app-desktop-home.tsx                # 桌面主页</span></span>
<span class="line"><span>├── app-desktop-setting.tsx             # 桌面设置</span></span>
<span class="line"><span>└── app-user-setting.tsx                # 用户设置</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="server-—-独立服务器-实验性" tabindex="-1"><code>server</code> — 独立服务器（实验性） <a class="header-anchor" href="#server-—-独立服务器-实验性" aria-label="Permalink to &quot;\`server\` — 独立服务器（实验性）&quot;">​</a></h3><ul><li><strong>技术</strong>：Ktor（独立可执行 JAR）</li><li><strong>当前状态</strong>：仅有 <code>/</code> 路由，返回 <code>&quot;Ktor&quot;</code></li><li><strong>用途</strong>：作为未来独立部署模式的起点，当前无实际功能</li></ul><h2 id="数据库设计" tabindex="-1">数据库设计 <a class="header-anchor" href="#数据库设计" aria-label="Permalink to &quot;数据库设计&quot;">​</a></h2>`,16)),(l(),o(p,null,{default:s(()=>[t(i,{id:"mermaid-196",class:"mermaid",graph:"erDiagram%0A%20%20%20%20material_video%20%7B%0A%20%20%20%20%20%20%20%20TEXT%20id%20PK%0A%20%20%20%20%20%20%20%20TEXT%20source_type%0A%20%20%20%20%20%20%20%20TEXT%20source_id%0A%20%20%20%20%20%20%20%20TEXT%20title%0A%20%20%20%20%20%20%20%20TEXT%20cover_url%0A%20%20%20%20%20%20%20%20TEXT%20description%0A%20%20%20%20%20%20%20%20INTEGER%20duration%0A%20%20%20%20%20%20%20%20TEXT%20pipeline_status%0A%20%20%20%20%20%20%20%20TEXT%20local_video_path%0A%20%20%20%20%20%20%20%20TEXT%20local_audio_path%0A%20%20%20%20%20%20%20%20TEXT%20transcript_path%0A%20%20%20%20%20%20%20%20TEXT%20extra%0A%20%20%20%20%20%20%20%20INTEGER%20created_at%0A%20%20%20%20%20%20%20%20INTEGER%20updated_at%0A%20%20%20%20%7D%0A%0A%20%20%20%20material_category%20%7B%0A%20%20%20%20%20%20%20%20TEXT%20id%20PK%0A%20%20%20%20%20%20%20%20TEXT%20name%0A%20%20%20%20%20%20%20%20TEXT%20description%0A%20%20%20%20%20%20%20%20INTEGER%20created_at%0A%20%20%20%20%20%20%20%20INTEGER%20updated_at%0A%20%20%20%20%7D%0A%0A%20%20%20%20material_video_category%20%7B%0A%20%20%20%20%20%20%20%20TEXT%20video_id%20FK%0A%20%20%20%20%20%20%20%20TEXT%20category_id%20FK%0A%20%20%20%20%7D%0A%0A%20%20%20%20app_config%20%7B%0A%20%20%20%20%20%20%20%20TEXT%20key%20PK%0A%20%20%20%20%20%20%20%20TEXT%20value%0A%20%20%20%20%7D%0A%0A%20%20%20%20material_video%20%7C%7C--o%7B%20material_video_category%20%3A%20%22has%22%0A%20%20%20%20material_category%20%7C%7C--o%7B%20material_video_category%20%3A%20%22has%22%0A"})]),fallback:s(()=>[...e[1]||(e[1]=[n(" Loading... ",-1)])]),_:1})),e[11]||(e[11]=a("h2",{id:"服务端口规划",tabindex:"-1"},[n("服务端口规划 "),a("a",{class:"header-anchor",href:"#服务端口规划","aria-label":'Permalink to "服务端口规划"'},"​")],-1)),a("table",m,[e[6]||(e[6]=a("thead",null,[a("tr",null,[a("th",null,"端口"),a("th",null,"服务"),a("th",null,"状态")])],-1)),a("tbody",null,[e[4]||(e[4]=a("tr",null,[a("td",null,[a("code",null,"7630")]),a("td",null,"React WebUI 开发服务器（Vite）"),a("td",null,"✅ 可用")],-1)),e[5]||(e[5]=a("tr",null,[a("td",null,[a("code",null,"7631")]),a("td",null,"Ktor API 服务器"),a("td",null,"✅ 可用")],-1)),a("tr",null,[e[2]||(e[2]=a("td",null,[a("code",null,"7632")],-1)),e[3]||(e[3]=a("td",null,"Python AI 处理服务",-1)),a("td",null,[t(c,{type:"warning",text:"尚待开发"})])])])]),e[12]||(e[12]=d('<h2 id="认证机制" tabindex="-1">认证机制 <a class="header-anchor" href="#认证机制" aria-label="Permalink to &quot;认证机制&quot;">​</a></h2><p>所有需要认证的 API 都通过 <code>Authorization: Bearer &lt;token&gt;</code> 头验证。Token 生成和管理在桌面应用设置中处理。</p><p>认证逻辑位于 <code>FredicaApi.jvm.kt</code> 的 <code>handleAuth()</code> 函数。</p><h2 id="图片代理与缓存" tabindex="-1">图片代理与缓存 <a class="header-anchor" href="#图片代理与缓存" aria-label="Permalink to &quot;图片代理与缓存&quot;">​</a></h2><p>所有来自外部平台（如 B 站 CDN）的封面图都通过 Fredica 内置的图片代理服务访问：</p><ol><li>前端请求 <code>/api/v1/ImageProxyRoute?url={encodedUrl}</code></li><li>代理服务检查本地缓存（<code>.data/cache/images/</code>），缓存键为 URL 的 SHA-256</li><li>缓存命中直接返回；未命中则从外部下载并写入缓存</li><li>响应头携带 <code>Cache-Control: public, max-age=31536000, immutable</code></li></ol><blockquote><p>图片代理接口无需认证，方便在 <code>&lt;img&gt;</code> 标签中直接使用。</p></blockquote>',7))])}const x=u(A,[["render",h]]);export{_ as __pageData,x as default};
